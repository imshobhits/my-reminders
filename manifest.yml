app:
  id: ari:cloud:ecosystem::app/947ac65b-ca66-412f-8e52-11e797583c52
  connect:
    key: com.not-atlassian.myreminders.local
    remote: connect
    authentication: jwt
  features:
    autoUserConsent: true
  storage:
    entities:
      - name: reminder
        attributes:
          issueId:
            type: integer
          issueKey:
            type: string
          originalIssueKey:
            type: string
          issueSummary:
            type: string
          originalIssueSummary:
            type: string
          message:
            type: string
          date:
            type: integer
          # Timestamp of the day of (e.g. 2014-08-12)
          day:
            type: string
          userAaid:
            type: string
          sendAttempts:
            type: integer
        indexes:
          - name: expired-reminders
            range:
              - date
            partition:
              - day
          - name: by-aaid
            range:
              - date
            partition:
              - userAaid
          - name: by-issue-id
            range:
              - date
            partition:
              - issueId
          - name: by-aaid-and-issue-id
            range:
              - date
            partition:
              - userAaid
              - issueId
          - name: by-aaid-and-issue-id-v2
            range:
              - date
            partition:
              - userAaid
              - issueId
remotes:
  - key: connect
    baseUrl: https://rmassaioli.public.atlastunnel.com
connectModules:
  jira:lifecycle:
    - key: lifecycle-events
      installed: /installed
      uninstalled: /uninstalled
  jira:webPanels:
    - location: atl.jira.view.issue.right.context
      url: /panel/jira/reminder/simple?issue_key={issue.key}&issue_id={issue.id}
      key: view-issue-reminders
      name:
        value: My reminders
      tooltip:
        value: Your reminders for this issue.
      conditions:
        - invert: false
          condition: user_is_logged_in
  jira:generalPages:
    - location: system.user.options/personal
      url: /panel/jira/reminders/view
      key: view-my-reminders
      name:
        value: My Reminders
    - location: completely-invalid-location
      url: /panel/v2/jira/reminder/create?issue_key={issue.key}&issue_id={issue.id}
      key: create-reminder-dialog
      name:
        value: Create reminder
      conditions:
        - invert: false
          condition: user_is_logged_in
  jira:webhooks:
    - event: jira:issue_updated
      url: /rest/webhook/issue/update
      key: webhook-1
    - event: jira:issue_deleted
      url: /rest/webhook/issue/delete
      key: webhook-2
  jira:jiraIssueGlances:
    - icon:
        height: 24
        url: /static/frontend/logo.svg
        width: 24
      content:
        type: label
        label:
          value: My Reminders
      key: view-issue-glance-reminders
      name:
        value: My Reminders
      target:
        url: /panel/jira/reminder/simple?issue_key={issue.key}&issue_id={issue.id}
        type: web_panel
modules:
  jira:globalPage:
    - key: sample-app-can-delete-hello-world
      function: main
      title: My Reminders General Page Example
  jira:issueContext:
    - key: view-issue-glance-reminders-v2
      resource: issueGlanceMain
      render: native
      resolver:
        function: resolver
      title: My Reminders
      label: Create issue reminders
  scheduledTrigger:
    - key: expirySchedulerJob
      function: expiryScheduler
      interval: hour
  ## Added a webtrigger not only for debugging but also to let people trigger reminders at a faster cadence. Expose to admins.
  webtrigger:
    - key: sendExpiredReminders
      function: expiryScheduler
  consumer:
    - key: expiredReminderSender
      # Name of the queue for which this consumer will be invoked
      queue: expiredReminders
      resolver:
        function: resolver
        # resolver function to be called with payload
        method: sendExpiredReminder
  function:
    - key: main
      handler: index.run
    - key: expiryScheduler
      handler: index.scheduleExpiryJobs
    - key: resolver
      handler: index.handler
resources:
  - key: issueGlanceMain
    path: src/frontend/index.jsx
permissions:
  scopes:
    - storage:app
    - read:connect-jira
    - write:connect-jira
    - read:jira-work
    - write:jira-work
